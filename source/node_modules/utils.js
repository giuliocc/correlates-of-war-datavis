function generateClassesDataset(original_dataset, bins) {
    var wars_dataset = generateWarsDataset(original_dataset)
    var spans_dataset = generateWarSpansDataset(original_dataset)

    var classes = []
    for(i=0; i<bins; i++){
        classes[i] = {"id": i, "last_end_date": new Date(-1,-1,-1)}
    }
    for(i=0; i<wars_dataset.length; i++){
        wars_dataset[i].start_date = spans_dataset[i].start_date
        wars_dataset[i].end_date = spans_dataset[i].end_date

        var available_classes = range(bins)
        while(true){
            var index = available_classes[Math.floor(Math.random() * available_classes.length)]
            if(classes[index].last_end_date < wars_dataset[i].start_date){
                wars_dataset[i].class = index
                classes[index].last_end_date = wars_dataset[i].end_date
                break
            }
            else{
                available_classes.splice(index, 1)
            }
        }
    }

    return wars_dataset
}

function generateWarsDataset(original_dataset){
    var new_dataset = []
    var current_war = {"war_id": null, "war_type": null, "war_name": null, "total_deaths": null, "total_participants": null, "side1": [], "side2": []}
    
    for(i=0; i<original_dataset.length; i++){
        var country = original_dataset[i]

        if(country.war_id == current_war.war_id){
            current_war.total_deaths += country.bat_death
            current_war.total_participants += 1
            if(country.side == 1){
                current_war.side1.push({
                    "code": country.ccode,
                    "name": country.state_name,
                    "deaths": country.bat_death
                })
            }
            else {
                current_war.side2.push({
                    "code": country.ccode,
                    "name": country.state_name,
                    "deaths": country.bat_death
                })
            }
        }
        else{
            if(current_war.war_id != null){
                new_dataset.push(Object.assign({}, current_war))
            }

            current_war.war_id = country.war_id
            current_war.war_type = country.war_type
            current_war.war_name = country.war_name
            current_war.total_deaths = country.bat_death
            current_war.total_participants = 1
            current_war.side1 = []
            current_war.side2 = []

            if(country.side == 1){
                current_war.side1 = [{
                    "code": country.ccode,
                    "name": country.state_name,
                    "deaths": country.bat_death
                }]
            }
            else {
                current_war.side2 = [{
                    "code": country.ccode,
                    "name": country.state_name,
                    "deaths": country.bat_death
                }]
            }
        }
    }
    new_dataset.push(Object.assign({}, current_war))

    return new_dataset
}


function generateWarSpansDataset(original_dataset){
    var war_spans = []
    var current_war = {"war_id": null, "start_date": null, "end_date": null}
    
    for(i=0; i<original_dataset.length; i++){
        var country = original_dataset[i]
        if(country.war_id == current_war.war_id){
            country_span = getCountrySpanInWar(country)
            var start_date = country_span.start_date
            var end_date = country_span.end_date

            if(start_date < current_war.start_date){
                current_war.start_date = start_date
            }

            if(end_date > current_war.end_date){
                current_war.end_date = end_date
            }
        }
        else{
            if(current_war.war_id != null){
                war_spans.push(Object.assign({}, current_war))
            }

            current_war.war_id = country.war_id

            var country_span = getCountrySpanInWar(country)
            current_war.start_date = country_span.start_date
            current_war.end_date = country_span.end_date
        }
    }
    war_spans.push(Object.assign({}, current_war))

    return war_spans
}

function getCountrySpanInWar(country){
    var start_date = new Date()
    start_date.setFullYear(country.start_year1, country.start_month1-1, country.start_day1)
    
    var end_date = new Date()
    if(country.end_year2 == -8){
        end_date.setFullYear(country.end_year1, country.end_month1-1, country.end_day1)
    }
    else{
        end_date.setFullYear(country.end_year2, country.end_month2-1, country.end_day2)
    }

    var country_span = {"start_date": start_date, "end_date": end_date}

    return country_span
}

function range(start, stop, step) {
    if (typeof stop == 'undefined') {
        // one param defined
        stop = start;
        start = 0;
    }

    if (typeof step == 'undefined') {
        step = 1;
    }

    if ((step > 0 && start >= stop) || (step < 0 && start <= stop)) {
        return [];
    }

    var result = [];
    for (var i = start; step > 0 ? i < stop : i > stop; i += step) {
        result.push(i);
    }

    return result;
};